<html>
<head>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    .screen {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      transition: transform 0.3s ease-in-out;
      background-color: white;
      display: flex;
      flex-direction: column;
    }
    #mainScreen {
      transform: translateX(0);
    }
    #secondScreen {
      transform: translateX(100%);
    }
    .slide-out-left {
      animation: slideOutLeft 0.3s ease-in-out forwards;
    }
    .slide-in-right {
      animation: slideInRight 0.3s ease-in-out forwards;
    }
    .slide-out-right {
      animation: slideOutRight 0.3s ease-in-out forwards;
    }
    .slide-in-left {
      animation: slideInLeft 0.3s ease-in-out forwards;
    }
    @keyframes slideOutLeft {
      from { transform: translateX(0); }
      to { transform: translateX(-100%); }
    }
    @keyframes slideInRight {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    @keyframes slideOutRight {
      from { transform: translateX(0); }
      to { transform: translateX(100%); }
    }
    @keyframes slideInLeft {
      from { transform: translateX(-100%); }
      to { transform: translateX(0); }
    }
    .header {
      display: flex;
      align-items: center;
      padding: 16px;
    }
    .header-centered {
      justify-content: center;
      position: relative;
    }
    .back-arrow {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      position: absolute;
      left: 16px;
    }
    .back-arrow svg {
      width: 14px;
      height: 14px;
    }
    h2 {
      margin: 0;
      font-size: 12px;
      font-weight: 400;
    }
    .content {
      padding: 16px;
      flex-grow: 1;
      overflow-y: auto;
    }
    #goToSecond {
      font-family: 'Inter';
      background-color: #0D99FF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 300;
      cursor: pointer;
      width: 100%; /* Make the button full width */
      box-sizing: border-box; /* Include padding in width calculation */
    }
    
    /* Add new styles for the second screen content */
    .input-field {
      width: 100%;
      padding: 8px;
      margin-bottom: 16px;
      border: 1px solid transparent;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 400;
      font-family: 'Inter', sans-serif;
      transition: border-color 0.3s ease, background-color 0.3s ease;
      background-color: #FFFFFF;
    }
    
    .input-field:hover {
      border-color: #E0E0E0; /* Light grey border on hover */
      background-color: #FFFFFF; /* White background on hover */
    }
    
    .input-field:focus {
      outline: none;
      border-color: #0D99FF;
      background-color: #FFFFFF;
    }
    
    .input-field::placeholder {
      font-family: 'Inter', sans-serif;
      color: #999;
      font-size: 12px;
      font-weight: 300;
    }
    
    textarea.input-field {
      resize: none;
      height: 72px;
    }
    
    .tag-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .tag {
      display: flex;
      align-items: center;
      padding: 4px 8px;
      background-color: #F0F0F0;
      border-radius: 4px;
      font-size: 12px;
    }
    
    .tag img {
      width: 16px;
      height: 16px;
      margin-right: 4px;
    }
    
    .attachments {
      margin-top: 24px;
    }
    
    .attachments-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .attachments-title {
      font-family: 'Inter';
      font-size: 12px;
      font-weight: 400;
    }
    
    .preset-group {
      font-size: 12px;
      color: #666;
    }
    
    .attachment-info {
      font-size: 10px;
      font-weight: 400;
      color: #666;
    }
    
    .create-issue-btn {
      font-family: 'Inter';
      padding: 10px 20px;
      border-radius: 6px;
      font-family: 'Inter';
      width: 100%;
      padding: 12px;
      background-color: #0D99FF;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 300;
      cursor: pointer;
      position: absolute;
      bottom: 16px;
      left: 0;
      right: 0;
      margin: 0 16px;
      width: calc(100% - 32px); 
    }
    
    .button-spacer {
      height: 60px;
    }
    
    .selection-info {
      margin-top: 16px;
      font-size: 12px;
    }
    
    .selection-url {
      word-break: break-all;
      color: #0D99FF;
      text-decoration: none;
    }
    
    .selection-error {
      color: #FF4D4D;
    }
    
    .file-name {
      font-size: 10px;
      color: #666;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 50%;
      display: flex;
      align-items: center;
    }
    
    .file-name-icon {
      width: 16px;
      height: 16px;
      margin-right: 4px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .file-name-icon svg {
      width: 12px;
      height: 12px;
    }
    
    .create-issue-btn:disabled {
      background-color: #5EB0EF;
      cursor: not-allowed;
    }
    
    .dropdown-container {
      margin-bottom: 12px;
    }
    
    .dropdown-label {
      display: block;
      font-family: 'Inter';
      font-size: 12px;
      font-weight: 400;
      margin-bottom: 4px;
      color: #333;
    }
    
    .dropdown {
      width: 100%;
      padding: 8px;
      border: 1px solid #E0E0E0;
      border-radius: 4px;
      font-size: 12px;
      font-family: 'Inter', sans-serif;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%23333333' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      padding-right: 24px;
    }
    
    .dropdown:hover {
      border-color: #0D99FF;
    }
    
    .dropdown:focus {
      outline: none;
      border-color: #0D99FF;
    }
    
    .dropdown option {
      font-size: 12px;
      color: #333333; /* Default color for options */
    }
    
    .dropdown option:first-child {
      font-size: 10px;
      color: #D4D4D4; /* Light gray color for the placeholder */
    }
    
    /* New style for the select element when showing the placeholder */
    .dropdown:invalid {
      color: #D4D4D4; /* Light gray color for the placeholder text */
    }
    
    .dropdown::-ms-expand {
      display: none;
    }
    
    .dropdown optgroup {
      font-weight: bold;
      font-style: normal;
      padding-left: 8px;
    }
    
    .dropdown option {
      padding-left: 16px;
    }
    
    .dropdown option:first-child {
      font-weight: normal;
    }
  </style>
</head>
<body>
  <div id="mainScreen" class="screen">
    <div class="header">
      <h2>Link a task</h2>
    </div>
    <div class="content">
      <button id="goToSecond">Create new task</button>
    </div>
  </div>
  <div id="secondScreen" class="screen">
    <div class="header header-centered">
      <button id="goToMain" class="back-arrow">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M20 11H7.83L13.42 5.41L12 4L4 12L12 20L13.41 18.59L7.83 13H20V11Z" fill="#333333"/>
        </svg>
      </button>
      <h2>Create new task</h2>
    </div>
    <div class="content">
      <input type="text" id="taskTitle" class="input-field" placeholder="Task title">
      <textarea class="input-field" placeholder="Add a description..." rows="3"></textarea>
      
      <div class="dropdown-container">
        <label for="spaceSelect" class="dropdown-label">Space</label>
        <select id="spaceSelect" class="input-field dropdown" required>
          <option value="" disabled selected>Choose a Space</option>
        </select>
      </div>
      
      <div class="dropdown-container">
        <label for="listSelect" class="dropdown-label">List</label>
        <select id="listSelect" class="input-field dropdown" required disabled>
          <option value="" disabled selected>Choose a List</option>
        </select>
      </div>
      
      <div class="attachments">
        <div class="attachments-header">
          <span class="attachments-title">Attachments</span>
          <span id="fileName" class="file-name"></span>
        </div>
        <p class="attachment-info">Task will be linked to the selected frame.</p>
        <div id="selectionInfo" class="selection-info"></div>
      </div>
      
      <div class="button-spacer"></div>
    </div>
    <button id="createTaskBtn" class="create-issue-btn" disabled>Create task</button>
  </div>

  <script>
    function focusTaskTitleInput() {
        console.log("Attempting to focus task title input");
        const taskTitleInput = document.querySelector('#secondScreen input.input-field');
        if (taskTitleInput) {
            taskTitleInput.focus();
            console.log("Task title input focused");
        } else {
            console.log("Task title input not found");
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
      const taskTitleInput = document.getElementById('taskTitle');
      const createTaskBtn = document.getElementById('createTaskBtn');

      taskTitleInput.addEventListener('input', function() {
        createTaskBtn.disabled = !this.value.trim();
      });
    });

    document.getElementById('goToSecond').onclick = () => {
        console.log("Create new task button clicked");
        document.getElementById('mainScreen').classList.add('slide-out-left');
        document.getElementById('secondScreen').classList.add('slide-in-right');
        parent.postMessage({ pluginMessage: { type: 'navigate', screen: 'second' } }, '*');
        console.log("Navigation message sent to plugin");
        // Focus the task title input after a short delay to ensure the animation is complete
        setTimeout(focusTaskTitleInput, 300);
    };

    document.getElementById('goToMain').onclick = () => {
        document.getElementById('secondScreen').classList.add('slide-out-right');
        document.getElementById('mainScreen').classList.add('slide-in-left');
        parent.postMessage({ pluginMessage: { type: 'navigate', screen: 'main' } }, '*');
    };

    let spacesWithFoldersAndListsData = [];

    function populateSpacesDropdown(spacesWithFoldersAndLists) {
      console.log('Populating spaces dropdown:', spacesWithFoldersAndLists);
      spacesWithFoldersAndListsData = spacesWithFoldersAndLists;
      const spaceDropdown = document.getElementById('spaceSelect');
      spaceDropdown.innerHTML = '<option value="" disabled selected>Choose a Space</option>';
      
      spacesWithFoldersAndLists.forEach(space => {
        const option = document.createElement('option');
        option.value = space.id;
        option.textContent = space.name;
        spaceDropdown.appendChild(option);
      });

      spaceDropdown.addEventListener('change', function() {
        updateListsDropdown(this.value);
      });
    }

    function updateListsDropdown(spaceId) {
      console.log('Updating lists dropdown for space:', spaceId);
      const listDropdown = document.getElementById('listSelect');
      listDropdown.innerHTML = '<option value="" disabled selected>Choose a List</option>';
      listDropdown.disabled = true;
      
      const selectedSpace = spacesWithFoldersAndListsData.find(space => space.id === spaceId);
      console.log('Selected space:', selectedSpace);
      
      if (selectedSpace) {
        let hasLists = false;

        // Add folderless lists
        selectedSpace.folderlessLists.forEach(list => {
          const option = document.createElement('option');
          option.value = list.id;
          option.textContent = list.name;
          listDropdown.appendChild(option);
          hasLists = true;
        });

        // Add lists from folders
        selectedSpace.folders.forEach(folder => {
          if (folder.lists.length > 0) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = folder.name;
            folder.lists.forEach(list => {
              const option = document.createElement('option');
              option.value = list.id;
              option.textContent = list.name;
              optgroup.appendChild(option);
            });
            listDropdown.appendChild(optgroup);
            hasLists = true;
          }
        });

        if (hasLists) {
          listDropdown.disabled = false;
        } else {
          const option = document.createElement('option');
          option.value = "";
          option.textContent = "No lists available";
          listDropdown.appendChild(option);
        }
      } else {
        console.log('No space found with id:', spaceId);
      }
    }

    onmessage = (event) => {
        console.log("Received message from plugin:", event.data.pluginMessage);
        if (event.data.pluginMessage.type === 'updateScreen') {
            console.log("Updating screen to:", event.data.pluginMessage.screen);
            const screen = event.data.pluginMessage.screen;
            if (screen === 'main') {
                setTimeout(() => {
                    document.getElementById('secondScreen').classList.remove('slide-in-right', 'slide-out-right');
                    document.getElementById('mainScreen').classList.remove('slide-out-left', 'slide-in-left');
                    document.getElementById('secondScreen').style.transform = 'translateX(100%)';
                    document.getElementById('mainScreen').style.transform = 'translateX(0)';
                }, 300);
            } else if (screen === 'second') {
                setTimeout(() => {
                    document.getElementById('mainScreen').classList.remove('slide-out-left', 'slide-in-left');
                    document.getElementById('secondScreen').classList.remove('slide-in-right', 'slide-out-right');
                    document.getElementById('mainScreen').style.transform = 'translateX(-100%)';
                    document.getElementById('secondScreen').style.transform = 'translateX(0)';
                    focusTaskTitleInput();
                }, 300);
            }
        } else if (event.data.pluginMessage.type === 'selectionUpdate') {
            console.log("Updating selection info with URL:", event.data.pluginMessage.url);
            const selectionInfo = document.getElementById('selectionInfo');
            selectionInfo.innerHTML = `<a href="${event.data.pluginMessage.url}" class="selection-url" target="_blank">${event.data.pluginMessage.url}</a>`;
            
            // Update node name
            const fileNameElement = document.getElementById('fileName');
            fileNameElement.textContent = event.data.pluginMessage.nodeName || '';
        } else if (event.data.pluginMessage.type === 'selectionError') {
            console.log("Displaying selection error");
            const selectionInfo = document.getElementById('selectionInfo');
            selectionInfo.innerHTML = '<span class="selection-error">Invalid selection. Please select a frame, section, or page.</span>';
            
            // Clear node name on error
            const fileNameElement = document.getElementById('fileName');
            fileNameElement.textContent = '';
        } else if (event.data.pluginMessage.type === 'spacesWithFoldersAndLists') {
          console.log('Received spacesWithFoldersAndLists:', event.data.pluginMessage.spacesWithFoldersAndLists);
          populateSpacesDropdown(event.data.pluginMessage.spacesWithFoldersAndLists);
        }
    };

    // Log when the script loads
    console.log("UI script loaded");

    document.getElementById('createTaskBtn').addEventListener('click', function() {
      const taskTitle = document.getElementById('taskTitle').value;
      const taskDescription = document.querySelector('textarea.input-field').value;
      const listId = document.getElementById('listSelect').value;
      const selectionInfo = document.getElementById('selectionInfo').textContent;

      parent.postMessage({
        pluginMessage: {
          type: 'createTask',
          taskTitle,
          taskDescription,
          listId,
          selectionInfo
        }
      }, '*');
    });
  </script>
</body>
</html>